

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Custom item types &mdash; BundleWrap 2.0.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/bundlewrap.css" type="text/css" />
  

  

  
        <link rel="author" title="About these documents"
              href="about.html"/>
    <link rel="top" title="BundleWrap 2.0.0 documentation" href="index.html"/>
        <link rel="up" title="Repository reference" href="repository.html"/>
        <link rel="next" title="Custom code" href="libs.html"/>
        <link rel="prev" title="Hooks" href="hooks.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="index.html">
        

        
          
          <img src="_static/logo.png" class="logo" />
        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#create-a-repository">Create a repository</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#run-a-command">Run a command</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#create-a-bundle">Create a bundle</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#create-a-file-template">Create a file template</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#apply-configuration">Apply configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#further-reading">Further reading</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#using-pip">Using <cite>pip</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#from-git">From git</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="migration_12.html">Migrating from BundleWrap 1.x to 2.x</a><ul>
<li class="toctree-l2"><a class="reference internal" href="migration_12.html#items-py">items.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_12.html#default-file-content-type">Default file content type</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_12.html#metadata-processors-and-item-generators">Metadata processors and item generators</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_12.html#custom-item-types">Custom item types</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_12.html#deterministic-templates">Deterministic templates</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="requirements.html">Requirements for managed systems</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="repository.html">Repository reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="nodes.py.html">nodes.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="groups.py.html">groups.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="bundles.html">Bundles</a></li>
<li class="toctree-l2"><a class="reference internal" href="hooks.html">Hooks</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Custom item types</a></li>
<li class="toctree-l2"><a class="reference internal" href="libs.html">Custom code</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugins.html">Plugins</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command Line Interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="cli.html#bw-apply"><code class="docutils literal"><span class="pre">bw</span> <span class="pre">apply</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="cli.html#bw-run"><code class="docutils literal"><span class="pre">bw</span> <span class="pre">run</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="cli.html#bw-nodes-and-bw-groups"><code class="docutils literal"><span class="pre">bw</span> <span class="pre">nodes</span></code> and <code class="docutils literal"><span class="pre">bw</span> <span class="pre">groups</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="cli.html#bw-debug"><code class="docutils literal"><span class="pre">bw</span> <span class="pre">debug</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="cli.html#bw-plot"><code class="docutils literal"><span class="pre">bw</span> <span class="pre">plot</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="cli.html#bw-test"><code class="docutils literal"><span class="pre">bw</span> <span class="pre">test</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api.html#example">Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="api.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="dev_contrib.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="dev_contrib.html#submitting-bug-reports">Submitting bug reports</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev_contrib.html#contributing-code">Contributing code</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev_contrib.html#help">Help</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="faq.html#technical">Technical</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#the-bundlewrap-project">The BundleWrap Project</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html">About</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="alternatives.html">Alternatives</a><ul>
<li class="toctree-l2"><a class="reference internal" href="alternatives.html#ansible">Ansible</a></li>
<li class="toctree-l2"><a class="reference internal" href="alternatives.html#bcfg2">BCFG2</a></li>
<li class="toctree-l2"><a class="reference internal" href="alternatives.html#chef">Chef</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">BundleWrap</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
          <li><a href="repository.html">Repository reference</a> &raquo;</li>
      
    <li>Custom item types</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="custom-item-types">
<span id="dev-item"></span><h1>Custom item types<a class="headerlink" href="#custom-item-types" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
<ul class="simple">
</ul>
</div>
<div class="section" id="step-0-understand-statedicts">
<h2>Step 0: Understand statedicts<a class="headerlink" href="#step-0-understand-statedicts" title="Permalink to this headline">¶</a></h2>
<p>To represent supposed vs. actual state, BundleWrap uses statedicts. These are
normal Python dictionaries with some restrictions:</p>
<ul class="simple">
<li>keys must be Unicode text</li>
<li>every value must be of one of these simple data types:<ul>
<li>bool</li>
<li>float</li>
<li>int</li>
<li>Unicode text</li>
<li>None</li>
</ul>
</li>
<li>...or a list/tuple containing only instances of one of the types above</li>
</ul>
<p>Additional information can be stored in statedicts by using keys that start with an underscore. You may only use this for caching purposes (e.g. storing rendered file template content while the &#8220;real&#8221; sdict information only contains a hash of this content). BundleWrap will ignore these keys and hide them from the user. The type restrictions noted above do not apply, but everything must be pickleable.</p>
</div>
<div class="section" id="step-1-create-an-item-module">
<h2>Step 1: Create an item module<a class="headerlink" href="#step-1-create-an-item-module" title="Permalink to this headline">¶</a></h2>
<p>Create a new file called <code class="file docutils literal"><span class="pre">/your/bundlewrap/repo/items/foo.py</span></code>. You can use this as a template:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">bundlewrap.items</span> <span class="kn">import</span> <span class="n">Item</span><span class="p">,</span> <span class="n">ItemStatus</span>


<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">Item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A foo.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">BLOCK_CONCURRENT</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">BUNDLE_ATTRIBUTE_NAME</span> <span class="o">=</span> <span class="s">&quot;foo&quot;</span>
    <span class="n">ITEM_ATTRIBUTES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;attribute&#39;</span><span class="p">:</span> <span class="s">&quot;default value&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">ITEM_TYPE_NAME</span> <span class="o">=</span> <span class="s">&quot;foo&quot;</span>
    <span class="n">REQUIRED_ATTRIBUTES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;attribute&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;Foo attribute:{}&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s">&#39;attribute&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">cdict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a statedict that describes the target state of this item</span>
<span class="sd">        as configured in the repo. An empty dict means that the item</span>
<span class="sd">        should not exist.</span>

<span class="sd">        Implementing this method is optional. The default implementation</span>
<span class="sd">        uses the attributes as defined in the bundle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">sdict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a statedict that describes the actual state of this item</span>
<span class="sd">        on the node. An empty dict means that the item does not exist</span>
<span class="sd">        on the node.</span>

<span class="sd">        For the item to validate as correct, the values for all keys in</span>
<span class="sd">        self.cdict() have to match this statedict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">sdict_verbose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statedict</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">actual</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a statedict based on the given one that is suitable for</span>
<span class="sd">        displaying information during interactive apply mode.</span>
<span class="sd">        The keys parameter indicates which keys are incorrect. It is</span>
<span class="sd">        sufficient to return a statedict that only represents these</span>
<span class="sd">        keys. The boolean actual parameter indicates if the source</span>
<span class="sd">        statedict is based on de facto node state aka sdict (True) or</span>
<span class="sd">        taken from the repo aka cdict (False).</span>

<span class="sd">        Implementing this method is optional. The default implementation</span>
<span class="sd">        returns the statedict unaltered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">fix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do whatever is necessary to correct this item. The given ItemStatus</span>
<span class="sd">        object has the following useful information:</span>

<span class="sd">            status.keys     list of cdict keys that need fixing</span>
<span class="sd">            status.cdict    cached copy of self.cdict()</span>
<span class="sd">            status.sdict    cached copy of self.sdict()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="step-2-define-attributes">
<h2>Step 2: Define attributes<a class="headerlink" href="#step-2-define-attributes" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">BUNDLE_ATTRIBUTE_NAME</span></code> is the name of the variable defined in a bundle module that holds the items of this type. If your bundle looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">foo</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="p">}</span>
</pre></div>
</div>
<p>...then you should put <code class="docutils literal"><span class="pre">BUNDLE_ATTRIBUTE_NAME</span> <span class="pre">=</span> <span class="pre">&quot;foo&quot;</span></code> here.</p>
<p><code class="docutils literal"><span class="pre">ITEM_ATTRIBUTES</span></code> is a dictionary of the attributes users will be able to configure for your item. For files, that would be stuff like owner, group, and permissions. Every attribute (even if it&#8217;s mandatory) needs a default value, <code class="docutils literal"><span class="pre">None</span></code> is totally acceptable:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ITEM_ATTRIBUTES</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;attr1&#39;</span><span class="p">:</span> <span class="s">&quot;default1&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">ITEM_TYPE_NAME</span></code> sets the first part of an items ID. For the file items, this is &#8220;file&#8221;. Therefore, file ID look this this: <code class="docutils literal"><span class="pre">file:/path</span></code>. The second part is the name a user assigns to your item in a bundle. Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ITEM_TYPE_NAME</span> <span class="o">=</span> <span class="s">&quot;foo&quot;</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">BLOCK_CONCURRENT</span></code> is a list of item types (e.g. <code class="docutils literal"><span class="pre">pkg_apt</span></code>), that cannot be applied in parallel with this type of item. May include this very item type itself. For most items this is not an issue (e.g. creating multiple files at the same time), but some types of items have to be applied sequentially (e.g. package managers usually employ locks to ensure only one package is installed at a time):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">BLOCK_CONCURRENT</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;pkg_apt&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">REQUIRED_ATTRIBUTES</span></code> is a list of attribute names that must be set on each item of this type. If BundleWrap encounters an item without all these attributes during bundle inspection, an exception will be raised. Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">REQUIRED_ATTRIBUTES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;attr1&#39;</span><span class="p">,</span> <span class="s">&#39;attr2&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="step-3-implement-methods">
<h2>Step 3: Implement methods<a class="headerlink" href="#step-3-implement-methods" title="Permalink to this headline">¶</a></h2>
<p>You should probably start with <code class="docutils literal"><span class="pre">sdict_actual</span></code>. Use <code class="docutils literal"><span class="pre">self.node.run(&quot;command&quot;)</span></code> to run shell commands on the current node and check the <code class="docutils literal"><span class="pre">stdout</span></code> property of the returned object.</p>
<p>The only other method you have to implement is <code class="docutils literal"><span class="pre">fix</span></code>. It doesn&#8217;t have to return anything and just uses <code class="docutils literal"><span class="pre">self.node.run()</span></code> to fix the item. To do this efficiently, it may use the provided parameters indicating which keys differ between the should-be sdict and the actual one. Both sdicts are also provided in case you need to know their values.</p>
<p>If you&#8217;re having trouble, try looking at the <a class="reference external" href="https://github.com/bundlewrap/bundlewrap/tree/master/src/bundlewrap/items">source code for the items that come with BundleWrap</a>. The <code class="docutils literal"><span class="pre">pkg_*</span></code> items are pretty simple and easy to understand while <code class="docutils literal"><span class="pre">files</span></code> is the most complex to date. Or just drop by on <a class="reference external" href="irc://chat.freenode.net/bundlewrap">IRC</a>, we&#8217;re glad to help.</p>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="libs.html" class="btn btn-neutral float-right" title="Custom code" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="hooks.html" class="btn btn-neutral" title="Hooks" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
    </p>
  </div>

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>